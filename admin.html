<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta name="robots" content="noindex,nofollow">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù…Ø³ØªØ´ÙÙ‰ Ø±ÙŠØ³Ø¨ÙƒØª â€” Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª (Ø¥Ø¯Ø§Ø±Ø©)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14;
      --card:#0f151d;
      --muted:#92a0b3;
      --text:#e8eef6;
      --brand:#7a6bff;
      --accent:#ff6b6b;
      --ok:#63e6a5;
      --border:1px solid rgba(255,255,255,.08);
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth;}
    body{
      margin:0;
      background:
        radial-gradient(900px 550px at 10% -10%, rgba(122,107,255,.18), transparent),
        radial-gradient(1000px 700px at 95% 120%, rgba(99,230,165,.10), transparent),
        #05070b;
      color:var(--text);
      font-family:"Cairo",sans-serif;
    }
    .container{width:min(1180px,93%);margin:auto}

    /* scrollbar */
    ::-webkit-scrollbar{width:8px;}
    ::-webkit-scrollbar-track{background:#05070b;}
    ::-webkit-scrollbar-thumb{
      background:linear-gradient(180deg,#7a6bff,#63e6a5);
      border-radius:999px;
    }

    /* Intro */
    #intro{
      position:fixed; inset:0; z-index:9999;
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      background:#05070b;
      animation:fadeOut .8s ease forwards;
      animation-delay:2.2s;
    }
    #intro .intro-content{ text-align:center; color:var(--text); animation:scaleIn .5s ease; }
    .intro-logo{ width:110px; height:110px; margin-bottom:14px; animation:pulse 1.8s infinite }
    @keyframes fadeOut{ to{ opacity:0; visibility:hidden } }
    @keyframes scaleIn{ from{ transform:scale(.9); opacity:.4 } to{ transform:none; opacity:1 } }
    @keyframes pulse{ 0%,100%{ transform:scale(1) } 50%{ transform:scale(1.06) } }

    /* NAV */
    nav{
      position:sticky;top:0;z-index:30;
      background:linear-gradient(180deg,rgba(12,16,24,.96),rgba(12,16,24,.8));
      padding:10px 0;
      border-bottom:var(--border);
      backdrop-filter:blur(16px);
      box-shadow:0 14px 40px rgba(0,0,0,.7);
    }
    .nav-inner{
      display:flex;align-items:center;justify-content:space-between;gap:12px
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .brand .logo{
      width:36px;height:36px;
      border-radius:10px;
      display:inline-block;
      background:center/cover no-repeat url('RTHospital.png');
      margin-left:8px;
      box-shadow:0 0 0 1px rgba(255,255,255,.18) inset;
    }
    .search{
      flex:1;display:flex;gap:8px;align-items:center;
      background:#121a25;border:var(--border);border-radius:12px;
      padding:8px 12px;margin:0 16px;
      box-shadow:0 0 0 1px rgba(122,107,255,.18);
    }
    .search input{all:unset;flex:1;color:var(--text)}
    .nav-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:9px 12px;border-radius:12px;border:var(--border);
      background:#1b2430;color:var(--text);font-weight:700;
      cursor:pointer;font-size:13px;
    }
    .btn.primary{background:#211b48;border-color:rgba(122,107,255,.6);}
    .btn.warn{background:#30191c;border-color:rgba(255,107,107,.5);}
    .total-badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;
      border-radius:999px;border:var(--border);background:#121a25;
      color:var(--text);font-size:12px;
    }
    .total-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--ok)}

    /* FILTERS */
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin:14px 0}
    .chip{
      padding:8px 12px;border-radius:999px;border:var(--border);
      background:#121a25;color:var(--muted);cursor:pointer;
      font-size:12px;
      transition:transform .12s ease, background .2s ease, color .2s ease;
    }
    .chip:hover{ transform:translateY(-1px); }
    .chip[aria-pressed="true"]{background:var(--text);color:#0b0f14;border-color:transparent}
    .chip[data-cat="ÙØ¶ÙŠ"]{ background:rgba(192,192,192,.12); color:#c0c0c0; border:1px solid #c0c0c0; }
    .chip[data-cat="Ø°Ù‡Ø¨ÙŠ"]{ background:rgba(255,215,0,.12); color:#ffd700; border:1px solid #ffd700; }
    .chip[data-cat="Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ"]{ background:rgba(229,228,226,.12); color:#9eaaff; border:1px solid #9eaaff; }
    .chip[data-cat="expired"]{ background:rgba(255,107,107,.12); color:#ff6b6b; border:1px solid #ff6b6b; }
    .chip[data-cat="soon"]{ background:rgba(255,165,0,.12); color:#ffa500; border:1px solid #ffa500; }

    /* GRID & CARD */
    .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
    .card{
      background:var(--card);border:var(--border);border-radius:16px;
      overflow:hidden;display:flex;flex-direction:column;position:relative;
      box-shadow:0 12px 30px rgba(0,0,0,.4);
      transition:transform .15s ease, box-shadow .2s ease, border-color .2s ease, background .2s ease;
    }
    .card:hover{
      transform:translateY(-2px);
      box-shadow:0 20px 46px rgba(0,0,0,.75);
      border-color:rgba(122,107,255,.9);
      background:radial-gradient(circle at top,rgba(122,107,255,.14),transparent 55%),#0b1119;
    }
    .media{background:#05070b;display:grid;place-items:center}
    .media img{width:100%;max-height:200px;object-fit:contain}
    .content{padding:10px 12px 12px;display:grid;gap:4px}
    .title{font-weight:800;font-size:15px}
    .line{color:var(--muted);font-size:12px;display:flex;justify-content:space-between}
    .status{margin-top:2px;font-size:12px}
    .badge{
      position:absolute;top:10px;left:10px;
      padding:0;border:none;background:transparent;z-index:2;
    }
    .category{
      position:absolute;top:10px;right:10px;padding:6px 10px;
      border-radius:999px;font-size:12px;border:var(--border);
      background:rgba(255,255,255,.06);
      backdrop-filter:blur(6px);
    }
    .cat-silver{ color:#c0c0c0; border-color:#c0c0c0; background:rgba(192,192,192,.12) }
    .cat-gold{   color:#ffd700; border-color:#ffd700; background:rgba(255,215,0,.12) }
    .cat-plat{   color:#9eaaff; border-color:#9eaaff; background:rgba(229,228,226,.12) }

    .actions{
      display:flex;gap:8px;padding:8px 12px;
      border-top:var(--border);background:#0f151d
    }
    .iconbtn{
      width:32px;height:32px;display:grid;place-items:center;
      border-radius:8px;border:var(--border);background:#141c28;
      cursor:pointer;font-size:15px;
    }
    .iconbtn.danger{background:#311c1f;border-color:rgba(255,107,107,.6)}
    .hidden{display:none!important}

    footer{text-align:center;padding:20px 0;color:var(--muted)}

    /* DIALOG */
    dialog{
      border:none;border-radius:16px;
      background:#0f141d;color:var(--text);
      width:min(480px,94%);
    }
    dialog::backdrop{background:rgba(0,0,0,.55)}
    form{display:grid;gap:12px;padding:18px}
    .form-title{font-weight:800;margin:0 0 4px}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{font-size:13px;font-weight:700}
    input,select{
      width:100%;padding:8px 10px;
      border-radius:10px;border:var(--border);
      background:#101722;color:var(--text);font-family:inherit;
    }
    .preview{
      display:flex;gap:12px;align-items:center;
      border:1px dashed rgba(255,255,255,.18);
      border-radius:12px;padding:10px;
      background:rgba(10,14,20,.6);
      transition:background .2s ease,border-color .2s ease;
    }
    .preview.drag{
      background:rgba(122,107,255,.1);
      border-color:rgba(122,107,255,.7);
    }
    .preview img{
      width:96px;height:96px;border-radius:10px;object-fit:cover;
      border:var(--border);margin-inline-start:8px;flex:0 0 96px;
      background:#05070b;
    }
    .preview-controls{flex:1;min-width:0;display:grid;gap:8px}
    .preview-controls input[type="file"]{direction:ltr}
    .preview-controls .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .dialog-actions{
      display:flex;justify-content:flex-end;gap:8px;margin-top:4px;
    }

    /* PILL */
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 10px; border-radius:999px;
      font-size:12px; line-height:1;
      background:transparent; color:currentColor; border:1px solid currentColor;
    }
    .pill .dot{
      width:6px; height:6px; border-radius:50%;
      background:currentColor;
      display:inline-block; transform:scale(1); transition:transform .2s ease;
    }
    .pill.ok      { color: var(--ok);     box-shadow:0 0 0 2px rgba(99,230,165,.12) inset; }
    .pill.soon    { color: #ffa500;       box-shadow:0 0 0 2px rgba(255,165,0,.12) inset; }
    .pill.expired { color: var(--accent); box-shadow:0 0 0 2px rgba(255,107,107,.12) inset; }
    .pill:hover .dot{ transform:scale(1.2); }

    @media(max-width:720px){
      .nav-inner{flex-wrap:wrap}
      .search{margin:8px 0}
      .row2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <!-- INTRO -->
  <div id="intro">
    <div class="intro-content">
      <img src="RTHospital.png" alt="Ø´Ø¹Ø§Ø± Ù…Ø³ØªØ´ÙÙ‰ Ø±ÙŠØ³Ø¨ÙƒØª" class="intro-logo" />
      <h2 style="margin:6px 0 2px">Ù…Ø³ØªØ´ÙÙ‰ Ø±ÙŠØ³Ø¨ÙƒØª</h2>
      <p style="margin:0; color:#9fb0c4; font-size:14px">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª</p>
    </div>
  </div>

  <nav>
    <div class="container nav-inner">
      <div class="brand"><span class="logo"></span><span>Ù…Ø³ØªØ´ÙÙ‰ Ø±ÙŠØ³Ø¨ÙƒØª</span></div>
      <div class="search"><input id="searchInput" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©" /></div>
      <div class="nav-actions">
        <div class="total-badge">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ <span id="totalCount">0</span> <span class="dot"></span></div>
        <button class="btn primary" id="addBtn">Ø¥Ø¶Ø§ÙØ©</button>
        <button class="btn" id="editModeBtn">ØªØ¹Ø¯ÙŠÙ„</button>
        <button class="btn warn" id="deleteModeBtn">Ø­Ø°Ù</button>
        <a href="logs-insurance.html" class="btn">Logs</a>
      </div>
    </div>
  </nav>

  <header class="container">
    <div class="filters">
      <button class="chip" data-cat="all" aria-pressed="true">Ø§Ù„ÙƒÙ„</button>
      <button class="chip" data-cat="ÙØ¶ÙŠ">ÙØ¶ÙŠ</button>
      <button class="chip" data-cat="Ø°Ù‡Ø¨ÙŠ">Ø°Ù‡Ø¨ÙŠ</button>
      <button class="chip" data-cat="Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ">Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ</button>
      <button class="chip" data-cat="soon">Ù‚Ø±ÙŠØ¨ ÙŠÙ†ØªÙ‡ÙŠ</button>
      <button class="chip" data-cat="expired">Ù…Ù†ØªÙ‡ÙŠ</button>
    </div>
  </header>

  <main class="container">
    <div class="grid" id="cards"></div>
  </main>

  <footer>Â© <span id="year"></span> Ù…Ø³ØªØ´ÙÙ‰ Ø±ÙŠØ³Ø¨ÙƒØª</footer>

  <dialog id="formDialog">
    <form id="personForm">
      <h3 class="form-title">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†</h3>
      <input type="hidden" id="editId" />
      <div class="preview" id="dropZone" title="Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„ÙØª ØµÙˆØ±Ø© Ù‡Ù†Ø§ Ø£Ùˆ Ø§Ù„ØµÙ‚Ù‡Ø§ Ø¨Ù€ Ctrl+V">
        <img id="photoPreview" alt="Ù…Ø¹Ø§ÙŠÙ†Ø©"/>
        <div class="preview-controls">
          <label>Ø§Ù„ØµÙˆØ±Ø©</label>
          <input type="file" id="photo" accept="image/*" />
          <div class="hint">ØªÙ‚Ø¯Ø± ØªØ³Ø­Ø¨-ÙˆØªÙÙ„Øª Ø§Ù„ØµÙˆØ±Ø© Ù‡Ù†Ø§ØŒ Ø£Ùˆ ØªØ¶ØºØ· <b>Ctrl+V</b> Ù„Ù„ØµÙ‚ ØµÙˆØ±Ø©.</div>
        </div>
      </div>

      <div class="row2">
        <div><label>Ø§Ù„Ø§Ø³Ù…</label><input type="text" id="name" required /></div>
        <div><label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label><input type="text" id="nid" required /></div>
      </div>
      <div class="row2">
        <div>
          <label>Ø§Ù„ÙØ¦Ø©</label>
          <select id="category" required>
            <option value="ÙØ¶ÙŠ">ÙØ¶ÙŠ</option>
            <option value="Ø°Ù‡Ø¨ÙŠ">Ø°Ù‡Ø¨ÙŠ</option>
            <option value="Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ">Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ</option>
          </select>
        </div>
        <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="date" id="expiry" required /></div>
      </div>

      <div class="dialog-actions">
        <button type="button" class="btn" id="cancelBtn">Ø¥Ù„ØºØ§Ø¡</button>
        <button type="submit" class="btn primary">Ø­ÙØ¸</button>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://piexwsbnbyfqkylqykpi.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBpZXh3c2JuYnlmcWt5bHF5a3BpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg5MDk4MDAsImV4cCI6MjA3NDQ4NTgwMH0.BDYZ1ZAuhLOg7WTUiAWsedNuwRVKfiK-LpUbRsnic3Q";
    const BUCKET = "ins-photos";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const cards=document.getElementById('cards');
    const searchInput=document.getElementById('searchInput');
    const chips=[...document.querySelectorAll('.chip')];
    const addBtn=document.getElementById('addBtn');
    const editBtn=document.getElementById('editModeBtn');
    const delBtn=document.getElementById('deleteModeBtn');
    const formDialog=document.getElementById('formDialog');
    const form=document.getElementById('personForm');
    const editId=document.getElementById('editId');
    const nameInput=document.getElementById('name');
    const nidInput=document.getElementById('nid');
    const categoryInput=document.getElementById('category');
    const expiryInput=document.getElementById('expiry');
    const photoInput=document.getElementById('photo');
    const photoPreview=document.getElementById('photoPreview');
    const dropZone=document.getElementById('dropZone');
    const totalCountEl=document.getElementById('totalCount');

    let state={q:'',cat:'all',edit:false,del:false};
    let ALL=[]; window.pastedImage=null;

    /* ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙÙ‚Ø· */
    async function signInWithPasswordOnly(){
      const { data:{ user } } = await sb.auth.getUser();
      if (user) return;

      const email = (prompt('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ:')||'').trim();
      const pwd   = (prompt('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:')||'').trim();
      if (!email || !pwd) { location.replace('index.html'); return; }

      const { error } = await sb.auth.signInWithPassword({ email, password: pwd });
      if (error) {
        alert('ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + (error.message || 'ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„/ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'));
        location.replace('index.html');
      }
    }

    /* ØªÙˆØ§Ø±ÙŠØ® ÙˆØ­Ø§Ù„Ø§Øª */
    const todayStr=()=>new Date().toISOString().slice(0,10);
    const isExpired=d=> d && d < todayStr();
    const daysLeft=d=> !d ? '' : Math.floor((new Date(d)-new Date(todayStr()))/86400000);
    function isSoon(d){ const left=daysLeft(d); return !isExpired(d) && Number.isFinite(left) && left<=5; }
    function catClass(cat){ if(cat==='ÙØ¶ÙŠ')return'cat-silver'; if(cat==='Ø°Ù‡Ø¨ÙŠ')return'cat-gold'; if(cat==='Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ')return'cat-plat'; return''; }

    /* Ø¨Ø·Ø§Ù‚Ø© */
    function cardHTML(x){
      const expired=isExpired(x.expiry);
      const left=daysLeft(x.expiry);
      const soon=!expired && Number.isFinite(left) && left<=5;
      const pill = expired
        ? `<span class="pill expired"><span class="dot"></span>Ù…Ù†ØªÙ‡ÙŠ</span>`
        : (soon
            ? `<span class="pill soon"><span class="dot"></span>Ù‚Ø±ÙŠØ¨ (${left} ÙŠÙˆÙ…)</span>`
            : `<span class="pill ok"><span class="dot"></span>Ø³Ø§Ø±ÙŠ${Number.isFinite(left)?` â€” ${left} ÙŠÙˆÙ…`:''}</span>`);
      const catCls=catClass(x.category);

      return `
        <article class="card">
          <span class="badge">${pill}</span>
          <span class="category ${catCls}">${x.category||''}</span>
          <div class="media">${x.photo? `<img src="${x.photo}" alt="${x.name}">` : ''}</div>
          <div class="content">
            <div class="title">${x.name||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</div>
            <div class="line"><span>Ù‡ÙˆÙŠØ©</span><span>${x.nid||'â€”'}</span></div>
            <div class="line"><span>ÙŠÙ†ØªÙ‡ÙŠ</span><span>${x.expiry||'â€”'}</span></div>
            <div class="status" style="color:${expired?'var(--accent)':'var(--ok)'}">${expired? 'Ø§Ù†ØªÙ‡Ù‰ â€” Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯' : 'Ø§Ù„ØªØ£Ù…ÙŠÙ† ÙØ¹Ù‘Ø§Ù„'}</div>
          </div>
          <div class="actions">
            <button class="iconbtn ${state.edit?'':'hidden'}" id="edit_${x.id}" title="ØªØ¹Ø¯ÙŠÙ„">âœï¸</button>
            <button class="iconbtn danger ${(state.del && expired)?'':'hidden'}" id="del_${x.id}" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
          </div>
        </article>`;
    }

    function bindRowActions(list){
      list.forEach(x=>{
        const e=document.getElementById('edit_'+x.id);
        const d=document.getElementById('del_'+x.id);
        if(e) e.onclick=()=>openForm(x.id);
        if(d) d.onclick=()=>tryDelete(x.id);
      });
    }

    /* CRUD */
    async function load(){
      const { data, error } = await sb.from('insurances').select('*').order('expiry',{ascending:true});
      ALL = error ? [] : data || [];
      render();
    }

    function render(){
      const q = state.q.trim().toLowerCase();
      const list = ALL
        .filter(x => (!q || x.name?.toLowerCase().includes(q) || x.nid?.includes(q)) &&
          (state.cat === 'all'
            ? true
            : state.cat === 'expired'
              ? isExpired(x.expiry)
              : state.cat === 'soon'
                ? isSoon(x.expiry)
                : x.category === state.cat))
        .sort((a,b)=> new Date(a.expiry) - new Date(b.expiry));

      totalCountEl.textContent = list.length || 0;
      cards.innerHTML = list.map(cardHTML).join('');
      bindRowActions(list);
    }

    function openForm(id){
      form.reset(); photoPreview.src=''; window.pastedImage=null; editId.value='';
      if(id){
        const x=ALL.find(i=>i.id===id); if(!x) return;
        editId.value=x.id;
        nameInput.value=x.name||'';
        nidInput.value=x.nid||'';
        categoryInput.value=x.category||'ÙØ¶ÙŠ';
        expiryInput.value=x.expiry||'';
        photoPreview.src=x.photo||'';
      }
      formDialog.showModal();
    }

    document.getElementById('cancelBtn').onclick=()=>{
      formDialog.close();
      window.pastedImage=null;
    };

    function dataUrlToBlob(d){
      const [h,b]=String(d).split(',');
      const mime=(h?.split(';')[0]||'').replace('data:','')||'image/png';
      const bin=atob(b||'');
      const u8=new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) u8[i]=bin.charCodeAt(i);
      return new Blob([u8],{type:mime});
    }
    function extFromType(t){
      return t==='image/jpeg'?'jpg':t==='image/png'?'png':t==='image/webp'?'webp':'bin';
    }
    function uniquePhotoPath(id, type){
      const ext = extFromType(type||'image/png');
      const nonce = Date.now()+'-'+Math.random().toString(36).slice(2,7);
      return `ins/${id}/${nonce}.${ext}`;
    }

    form.onsubmit=async e=>{
      e.preventDefault();
      const id = editId.value || crypto.randomUUID();
      const existing = ALL.find(i=>i.id===id) || null;

      let fileOrBlob=null;
      if(window.pastedImage) fileOrBlob = dataUrlToBlob(window.pastedImage);
      else if(photoInput.files[0]) fileOrBlob = photoInput.files[0];

      let photoUrl = existing?.photo || null;
      if(fileOrBlob){
        const path = uniquePhotoPath(id, fileOrBlob.type);
        const up = await sb.storage.from(BUCKET).upload(path, fileOrBlob, {
          upsert:false,
          contentType:fileOrBlob.type || 'image/png',
          cacheControl:'31536000'
        });
        if(up.error){ alert('ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©: '+up.error.message); return; }
        const { data } = sb.storage.from(BUCKET).getPublicUrl(path);
        photoUrl = data.publicUrl;
      }

      const obj={
        id,
        name:nameInput.value.trim(),
        nid:nidInput.value.trim(),
        category:categoryInput.value,
        expiry:expiryInput.value,
        photo:photoUrl
      };
      const { error } = await sb.from('insurances').upsert(obj);
      if(error){ alert('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: '+error.message); return; }

      formDialog.close();
      window.pastedImage=null;
      await load();
    };

    async function tryDelete(id){
      if(!confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ')) return;
      await sb.from('insurances').delete().eq('id', id);
      await load();
    }

    /* Ù„ØµÙ‚/Ø³Ø­Ø¨ ØµÙˆØ±Ø© */
    document.addEventListener("paste", (event) => {
      if (!formDialog.open) return;
      const items = event.clipboardData?.items || [];
      for (let i=0;i<items.length;i++){
        if(items[i].type.indexOf("image")!==-1){
          const file = items[i].getAsFile();
          handleFile(file);
          event.preventDefault();
          break;
        }
      }
    });
    ['dragenter','dragover'].forEach(ev=>{
      dropZone.addEventListener(ev, e=>{e.preventDefault(); dropZone.classList.add('drag');});
    });
    ['dragleave','drop'].forEach(ev=>{
      dropZone.addEventListener(ev, e=>{e.preventDefault(); dropZone.classList.remove('drag');});
    });
    dropZone.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if(file) handleFile(file);
    });
    photoInput.onchange=()=>{ if(photoInput.files[0]) handleFile(photoInput.files[0]); };
    function handleFile(file){
      const fr=new FileReader();
      fr.onload=()=>{
        photoPreview.src=fr.result;
        window.pastedImage=fr.result;
      };
      fr.readAsDataURL(file);
    }

    /* UI */
    addBtn.onclick=()=>openForm();
    editBtn.onclick=()=>{state.edit=!state.edit;render();}
    delBtn.onclick=()=>{state.del=!state.del;render();}
    searchInput.oninput=()=>{state.q=searchInput.value;render();}
    chips.forEach(c=>c.onclick=()=>{
      chips.forEach(x=>x.setAttribute('aria-pressed','false'));
      c.setAttribute('aria-pressed','true');
      state.cat=c.dataset.cat;
      render();
    });
    document.getElementById('year').textContent=new Date().getFullYear();

    await signInWithPasswordOnly();
    await load();
    setTimeout(()=>{
      const el=document.getElementById('intro');
      if(el) el.style.display='none';
    },2400);
  </script>
</body>
</html>
